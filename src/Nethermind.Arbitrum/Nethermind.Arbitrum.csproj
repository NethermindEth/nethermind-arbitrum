<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
  </PropertyGroup>

  <PropertyGroup>
    <ArbitrumConfigsDir>Properties</ArbitrumConfigsDir>
    <RunnerProjectRelativePath>..\Nethermind\src\Nethermind\Nethermind.Runner\Nethermind.Runner.csproj</RunnerProjectRelativePath>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Nethermind\src\Nethermind\Nethermind.Api\Nethermind.Api.csproj" />
    <ProjectReference Include="..\Nethermind\src\Nethermind\Nethermind.Core\Nethermind.Core.csproj"/>
    <ProjectReference Include="..\Nethermind\src\Nethermind\Nethermind.HealthChecks\Nethermind.HealthChecks.csproj" />
    <ProjectReference Include="..\Nethermind\src\Nethermind\Nethermind.Init\Nethermind.Init.csproj" />
    <ProjectReference Include="..\Nethermind\src\Nethermind\Nethermind.Merge.Plugin\Nethermind.Merge.Plugin.csproj" />
    <ProjectReference Include="$(RunnerProjectRelativePath)">
      <ReferenceOutputAssembly>false</ReferenceOutputAssembly> <!-- Prevent circular dependency -->
      <Private>false</Private>
    </ProjectReference>
  </ItemGroup>

  <PropertyGroup Label="Temporary config for Stylus support">
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <DisableRuntimeMarshalling>true</DisableRuntimeMarshalling>
    <StylusLibDir>Arbos/Stylus</StylusLibDir>
  </PropertyGroup>

  <ItemGroup Label="Temporary config for Stylus support">
    <None Update="$(StylusLibDir)/runtimes/linux-arm64/native/libstylus.so">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>true</Pack>
      <PackagePath>%(RelativeDir)%(Filename)%(Extension)</PackagePath>
    </None>
    <None Update="$(StylusLibDir)/runtimes/linux-x64/native/libstylus.so">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>true</Pack>
      <PackagePath>%(RelativeDir)%(Filename)%(Extension)</PackagePath>
    </None>
    <None Update="$(StylusLibDir)/runtimes/osx-arm64/native/libstylus.dylib">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>true</Pack>
      <PackagePath>%(RelativeDir)%(Filename)%(Extension)</PackagePath>
    </None>
    <None Update="$(StylusLibDir)/runtimes/win-x64/native/stylus.dll">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>true</Pack>
      <PackagePath>%(RelativeDir)%(Filename)%(Extension)</PackagePath>
    </None>
  </ItemGroup>

  <ItemGroup>
    <None Include="$(ArbitrumConfigsDir)\chainspec\**\*.*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Include="$(ArbitrumConfigsDir)\configs\**\*.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
    </None>
  </ItemGroup>

  <Target Name="GetRunnerOutputPath" AfterTargets="AfterBuild">
    <MSBuild Projects="$(RunnerProjectRelativePath)"
             Targets="GetTargetPath"
             Properties="Configuration=$(Configuration)">
      <Output TaskParameter="TargetOutputs" ItemName="RunnerAssembly" />
    </MSBuild>

    <PropertyGroup>
      <RunnerOutputDirPath>$([System.IO.Path]::GetDirectoryName('%(RunnerAssembly.Identity)'))</RunnerOutputDirPath>
    </PropertyGroup>
  </Target>

  <Target Name="CopyFilesToRunner" AfterTargets="GetRunnerOutputPath" DependsOnTargets="GetRunnerOutputPath">
    <PropertyGroup>
      <RunnerPluginDir>$(RunnerOutputDirPath)/plugins</RunnerPluginDir>
      <RunnerConfigsDir>$(RunnerOutputDirPath)/configs</RunnerConfigsDir>
      <RunnerChainspecDir>$(RunnerOutputDirPath)/chainspec</RunnerChainspecDir>
      <RunnerStylusLibDir>$(RunnerOutputDirPath)/plugins/Arbos/Stylus</RunnerStylusLibDir>
    </PropertyGroup>

    <ItemGroup>
      <FilesToCopyToPluginsDir Include="$(OutputPath)Nethermind.Arbitrum.*" />
      <FilesToCopyToConfigsDir Include="$(OutputPath)\$(ArbitrumConfigsDir)\configs\**\*.*" />
      <FilesToCopyToChainspecDir Include="$(OutputPath)\$(ArbitrumConfigsDir)\chainspec\**\*.*" />
      <FilesToCopyToStylusLibDir Include="$(OutputPath)\$(StylusLibDir)\**\*.*" />
    </ItemGroup>

    <Message Text="Copying Arbitrum plugin and its configs after build..." Importance="high" />
    <Copy SourceFiles="@(FilesToCopyToPluginsDir)" DestinationFolder="$(RunnerPluginDir)" />
    <Copy SourceFiles="@(FilesToCopyToConfigsDir)" DestinationFolder="$(RunnerConfigsDir)" />
    <Copy SourceFiles="@(FilesToCopyToChainspecDir)" DestinationFolder="$(RunnerChainspecDir)" />
    <Copy SourceFiles="@(FilesToCopyToStylusLibDir)"
          DestinationFiles="@(FilesToCopyToStylusLibDir-&gt;'$(RunnerStylusLibDir)\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Message Text="Copied @(FilesToCopyToPluginsDir-&gt;Count()) files to $(RunnerPluginDir)" Importance="high" />
    <Message Text="Copied @(FilesToCopyToConfigsDir-&gt;Count()) files to $(RunnerConfigsDir)" Importance="high" />
    <Message Text="Copied @(FilesToCopyToChainspecDir-&gt;Count()) files to $(RunnerChainspecDir)" Importance="high" />
    <Message Text="Copied @(FilesToCopyToStylusLibDir-&gt;Count()) files to $(RunnerStylusLibDir)" Importance="high" />
  </Target>

</Project>
