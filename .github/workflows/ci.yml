name: Nethermind.Arbitrum CI & Coverage

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       project:
  #         - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
  #         - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj

  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v4
  #     with:
  #       submodules: true

  #   - name: Setup .NET
  #     uses: actions/setup-dotnet@v4
  #     with:
  #       dotnet-version: '9.0.x'

  #   - name: Build ${{ matrix.project }}
  #     run: dotnet build ${{ matrix.project }} --configuration Release

#  format-check:
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        project:
#          - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
#          - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj
#
#    steps:
#    - name: Checkout repository
#      uses: actions/checkout@v4
#
#    - name: Setup .NET
#      uses: actions/setup-dotnet@v4
#      with:
#        dotnet-version: '9.0.x'
#
#    - name: Install dotnet-format
#      run: dotnet tool install -g dotnet-format
#
#    - name: Check code format for ${{ matrix.project }}
#      run: dotnet format ${{ matrix.project }} --verify-no-changes

  test-and-coverage:
    runs-on: ubuntu-latest
    # needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Run tests with Arbitrum-only coverage (Cobertura)
      run: |
        # Produce Cobertura for only the Nethermind.Arbitrum assembly
        dotnet test src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj \
          --configuration Release \
          --verbosity minimal \
          --logger trx \
          --logger "console;verbosity=normal" \
          /p:CollectCoverage=true \
          /p:CoverletOutput=./coverage/coverage \
          /p:CoverletOutputFormat=cobertura \
          /p:Include="[Nethermind.Arbitrum*]*"

#    - name: Copy coverage to predictable location
#      if: always()
#      run: |
#        # Coverlet MSBuild writes relative to the test project; copy to repo root
#        if [ -f src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml ]; then
#          cp src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml coverage.cobertura.xml
#        else
#          echo "Coverage file missing: src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml"
#          exit 1
#        fi
#
#    - name: Code Coverage Summary (Arbitrum only)
#      uses: irongut/CodeCoverageSummary@v1.2.0
#      if: always()
#      with:
#        filename: coverage.cobertura.xml
#        badge: true
#        fail_below_min: true
#        format: markdown
#        hide_branch_rate: false
#        hide_complexity: true
#        indicators: true
#        output: both
#        thresholds: '60 80'
#
#    - name: Add coverage PR comment
#      uses: marocchino/sticky-pull-request-comment@v2
#      if: github.event_name == 'pull_request' && always()
#      with:
#        recreate: true
#        path: code-coverage-results.md
#
#    - name: Upload coverage artifacts
#      uses: actions/upload-artifact@v4
#      if: always()
#      with:
#        name: coverage
#        path: |
#          coverage.cobertura.xml
#          code-coverage-results.md
#        retention-days: 7
