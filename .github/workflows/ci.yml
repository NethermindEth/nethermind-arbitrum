name: Nethermind.Arbitrum CI & Coverage

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
          - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build ${{ matrix.project }}
      run: dotnet build ${{ matrix.project }} --configuration Release

  format-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
          - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install dotnet-format
      run: dotnet tool install -g dotnet-format

    - name: Check code format for ${{ matrix.project }}
      run: dotnet format ${{ matrix.project }} --verify-no-changes

  test-and-coverage:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Run tests with coverage
      run: |
        # Use Coverlet.MSBuild package instead of global coverage collection
        dotnet test src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj \
          --configuration Release \
          --verbosity normal \
          --logger trx \
          --logger "console;verbosity=detailed" \
          /p:CollectCoverage=true \
          /p:CoverletOutput=./coverage/ \
          /p:CoverletOutputFormat=cobertura \
          '/p:Exclude="[*.Test]*,[Nethermind]*,[Nethermind.Core]*,[Nethermind.Abi]*,[Nethermind.Blockchain]*,[Nethermind.Config]*,[Nethermind.Consensus]*,[Nethermind.Crypto]*,[Nethermind.Db]*,[Nethermind.Evm]*,[Nethermind.Facade]*,[Nethermind.JsonRpc]*,[Nethermind.Logging]*,[Nethermind.Network]*,[Nethermind.Serialization]*,[Nethermind.Specs]*,[Nethermind.State]*,[Nethermind.Trie]*,[Nethermind.TxPool]*,[Nethermind.Wallet]*,[Nethermind.Init]*,[Nethermind.KeyStore]*,[Nethermind.Synchronization]*,[Nethermind.Merge]*,[Nethermind.Sockets]*,[Nethermind.Api]*,[Nethermind.Runner]*,[Nethermind.Cli]*,[Nethermind.Seq]*,[Nethermind.Channels]*,[Nethermind.Node]*,[Nethermind.Mev]*,[Nethermind.Monitoring]*,[Nethermind.Era1]*,[Nethermind.Grpc]*,[Nethermind.Merkleization]*,[Nethermind.HealthChecks]*,[System.Text.RegularExpressions.Generated]*"' \
          '/p:Include="[Nethermind.Arbitrum]*"' \
          '/p:ExcludeByFile="**/*.Designer.cs,**/*.generated.cs,**/*.AssemblyInfo.cs,**/Properties/**"'

    - name: Generate coverage report
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator \
          -reports:"./src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml" \
          -targetdir:"./coveragereport" \
          -reporttypes:"HtmlInline"

    - name: Check coverage threshold
      run: |
        # Use the specific coverage file from Coverlet MSBuild  
        COVERAGE_FILE="./src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml"
        echo "Using coverage file: $COVERAGE_FILE"
        
        if [ ! -f "$COVERAGE_FILE" ]; then
          echo "❌ No coverage file found"
          echo "COVERAGE_PERCENT=0.0" >> $GITHUB_ENV
          echo "COVERAGE_STATUS=failed" >> $GITHUB_ENV
          exit 1
        fi
        
        # Extract line coverage percentage for Nethermind.Arbitrum package specifically
        ARBITRUM_COVERAGE=$(grep -A 1 'package name="Nethermind.Arbitrum"' "$COVERAGE_FILE" | grep -o 'line-rate="[^"]*"' | cut -d'"' -f2)
        if [ -z "$ARBITRUM_COVERAGE" ]; then
          echo "❌ No Nethermind.Arbitrum package found in coverage"
          COVERAGE_PERCENT=0.0
        else
          # one decimal place
          COVERAGE_PERCENT=$(echo "$ARBITRUM_COVERAGE" | awk '{printf "%.1f", $1 * 100}')
        fi
        echo "Nethermind.Arbitrum line coverage: ${COVERAGE_PERCENT}%"
        echo "COVERAGE_PERCENT=${COVERAGE_PERCENT}" >> $GITHUB_ENV
        
        THRESHOLD=60.0
        if awk "BEGIN {exit !(${COVERAGE_PERCENT} < ${THRESHOLD})}"; then
          echo "❌ Coverage ${COVERAGE_PERCENT}% is below the required ${THRESHOLD}% threshold"
          echo "COVERAGE_STATUS=failed" >> $GITHUB_ENV
          echo "::warning::Coverage ${COVERAGE_PERCENT}% is below ${THRESHOLD}% threshold"
        else
          echo "✅ Coverage ${COVERAGE_PERCENT}% meets the required ${THRESHOLD}% threshold"
          echo "COVERAGE_STATUS=passed" >> $GITHUB_ENV
        fi

        # Save a small summary artifact for future delta comparison
        mkdir -p coverage-summary
        echo "${COVERAGE_PERCENT}" > coverage-summary/coverage.txt

    - name: Download baseline coverage summary (base branch)
      if: github.event_name == 'pull_request'
      uses: dawidd6/action-download-artifact@v3
      continue-on-error: true
      with:
        workflow: ci.yml
        branch: ${{ github.base_ref }}
        name: coverage-summary
        path: baseline
        workflow_conclusion: success

    - name: Build minimal PR coverage comment
      if: github.event_name == 'pull_request'
      env:
        RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        THRESHOLD: 60.0
      run: |
        NEW_COV=${COVERAGE_PERCENT}
        BASE_FILE=baseline/coverage.txt
        if [ -f "$BASE_FILE" ]; then
          BASE_COV=$(cat "$BASE_FILE")
          DELTA=$(awk -v n="$NEW_COV" -v b="$BASE_COV" 'BEGIN {printf "%+.1f", n-b}')
        else
          BASE_COV="N/A"
          DELTA="N/A"
        fi
        if awk "BEGIN {exit !(${NEW_COV} < ${THRESHOLD})}"; then
          RESULT="❌ Below ${THRESHOLD}%"
        else
          RESULT="✅ Meets ${THRESHOLD}%"
        fi
        {
          echo "### Coverage"
          echo "**Nethermind.Arbitrum**: ${NEW_COV}% (Δ ${DELTA}) — ${RESULT}"
          echo ""
          echo "[Full HTML report (artifact)](${RUN_URL})"
        } > coverage_comment.md

    - name: Post minimal PR comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        path: coverage_comment.md

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: |
          ./coverage
          ./coveragereport
          ./src/Nethermind.Arbitrum.Test/coverage
        retention-days: 7

    - name: Upload coverage summary (for baseline comparison)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-summary
        path: coverage-summary/coverage.txt
        retention-days: 14
