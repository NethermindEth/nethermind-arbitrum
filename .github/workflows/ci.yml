name: Nethermind.Arbitrum CI & Coverage

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
          - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build ${{ matrix.project }}
      run: dotnet build ${{ matrix.project }} --configuration Release

  format-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - src/Nethermind.Arbitrum/Nethermind.Arbitrum.csproj
          - src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install dotnet-format
      run: dotnet tool install -g dotnet-format

    - name: Check code format for ${{ matrix.project }}
      run: dotnet format ${{ matrix.project }} --verify-no-changes

  test-and-coverage:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Run tests with coverage
      run: |
        # Use Coverlet.MSBuild package instead of global coverage collection
        dotnet test src/Nethermind.Arbitrum.Test/Nethermind.Arbitrum.Test.csproj \
          --configuration Release \
          --verbosity normal \
          --logger trx \
          --logger "console;verbosity=detailed" \
          /p:CollectCoverage=true \
          /p:CoverletOutput=./coverage/ \
          /p:CoverletOutputFormat=cobertura \
          '/p:Exclude="[*.Test]*,[Nethermind]*,[Nethermind.Core]*,[Nethermind.Abi]*,[Nethermind.Blockchain]*,[Nethermind.Config]*,[Nethermind.Consensus]*,[Nethermind.Crypto]*,[Nethermind.Db]*,[Nethermind.Evm]*,[Nethermind.Facade]*,[Nethermind.JsonRpc]*,[Nethermind.Logging]*,[Nethermind.Network]*,[Nethermind.Serialization]*,[Nethermind.Specs]*,[Nethermind.State]*,[Nethermind.Trie]*,[Nethermind.TxPool]*,[Nethermind.Wallet]*,[Nethermind.Init]*,[Nethermind.KeyStore]*,[Nethermind.Synchronization]*,[Nethermind.Merge]*,[Nethermind.Sockets]*,[Nethermind.Api]*,[Nethermind.Runner]*,[Nethermind.Cli]*,[Nethermind.Seq]*,[Nethermind.Channels]*,[Nethermind.Node]*,[Nethermind.Mev]*,[Nethermind.Monitoring]*,[Nethermind.Era1]*,[Nethermind.Grpc]*,[Nethermind.Merkleization]*,[Nethermind.HealthChecks]*,[System.Text.RegularExpressions.Generated]*"' \
          '/p:Include="[Nethermind.Arbitrum]*"' \
          '/p:ExcludeByFile="**/*.Designer.cs,**/*.generated.cs,**/*.AssemblyInfo.cs,**/Properties/**"'

    - name: Generate coverage report
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator \
          -reports:"./src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml" \
          -targetdir:"./coveragereport" \
          -reporttypes:"HtmlInline;MarkdownSummary"

    - name: Check coverage threshold
      run: |
        # Use the specific coverage file from Coverlet MSBuild  
        COVERAGE_FILE="./src/Nethermind.Arbitrum.Test/coverage/coverage.cobertura.xml"
        echo "Using coverage file: $COVERAGE_FILE"
        
        if [ ! -f "$COVERAGE_FILE" ]; then
          echo "âŒ No coverage file found"
          echo "COVERAGE_PERCENT=0" >> $GITHUB_ENV
          echo "COVERAGE_STATUS=failed" >> $GITHUB_ENV
          exit 1
        fi
        
        # Extract line coverage percentage for Nethermind.Arbitrum package specifically
        ARBITRUM_COVERAGE=$(grep -A 1 'package name="Nethermind.Arbitrum"' "$COVERAGE_FILE" | grep -o 'line-rate="[^"]*"' | cut -d'"' -f2)
        if [ -z "$ARBITRUM_COVERAGE" ]; then
          echo "âŒ No Nethermind.Arbitrum package found in coverage"
          COVERAGE_PERCENT=0
        else
          COVERAGE_PERCENT=$(echo "$ARBITRUM_COVERAGE" | awk '{printf "%.0f", $1 * 100}')
        fi
        echo "Nethermind.Arbitrum line coverage: ${COVERAGE_PERCENT}%"
        echo "COVERAGE_PERCENT=${COVERAGE_PERCENT}" >> $GITHUB_ENV
        
        # Check if coverage meets 60% threshold
        if [ "$COVERAGE_PERCENT" -lt 60 ]; then
          echo "âŒ Coverage ${COVERAGE_PERCENT}% is below the required 60% threshold"
          echo "COVERAGE_STATUS=failed" >> $GITHUB_ENV
          # For now, report but don't fail build to test the workflow
          echo "::warning::Coverage ${COVERAGE_PERCENT}% is below 60% threshold"
        else
          echo "âœ… Coverage ${COVERAGE_PERCENT}% meets the required 60% threshold"
          echo "COVERAGE_STATUS=passed" >> $GITHUB_ENV
        fi

    - name: Add coverage PR comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request' && always()
      with:
        recreate: true
        path: coveragereport/Summary.md

    - name: Write coverage status
      if: always()
      run: |
        echo "### ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ env.COVERAGE_STATUS == 'passed' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage:** ${{ env.COVERAGE_PERCENT }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f coveragereport/Summary.md ]; then
          cat coveragereport/Summary.md >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: |
          ./coverage
          ./coveragereport
        retention-days: 7
