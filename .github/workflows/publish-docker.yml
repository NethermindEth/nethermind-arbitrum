name: Publish Docker image

on:
  workflow_dispatch:
    inputs:
      image-name:
        description: Image name
        required: true
        default: nethermind-arbitrum
      tag:
        description: Image tag
        required: true
      dockerfile:
        description: Dockerfile
        required: true
        default: Dockerfile
      build-config:
        description: Build configuration
        required: true
        default: release
        type: choice
        options: [release, debug]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  attestations: write
  contents: read

jobs:
  Build:
    name: Build ${{ matrix.platform }}
    strategy:
      matrix:
        include:
          - platform: linux/arm64
            runner: ubuntu-arm64-8-core
            suffix: linux-arm64
          - platform: linux/amd64
            runner: ubuntu-latest
            suffix: linux-amd64
    uses: NethermindEth/github-workflows/.github/workflows/docker-build-push-jfrog.yaml@v1.9.0
    with:
      runner: ${{ matrix.runner }}
      group_name: core
      image_name: ${{ github.event.inputs.image-name }}
      dockerfile_path: ${{ github.event.inputs.dockerfile }}
      platforms: ${{ matrix.platform }}
      pre_build_script: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/graalvm/
        sudo rm -rf /usr/local/.ghcup/
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/lib/node_modules
        sudo apt-get clean
        docker system prune -af --volumes
        df -h
      docker_build_args: |
        BUILD_CONFIG=${{ github.event.inputs.build-config }}
        BUILD_TIMESTAMP=${{ github.run_number }}
        CI=true
        COMMIT_HASH=${{ github.sha }}
      additional_tags: ${{ github.event.inputs.tag }}-${{ matrix.suffix }}
    secrets: inherit

  Create-Manifest:
    needs: Build
    runs-on: ubuntu-latest
    steps:
      - name: Log in to JFrog
        uses: docker/login-action@v3
        with:
          registry: nethermind.jfrog.io
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_PASSWORD }}

      - name: Create and push multi-platform manifest
        run: |
          IMAGE_BASE="nethermind.jfrog.io/core-oci-local-dev/${{ github.event.inputs.image-name }}"
          TAG="${{ github.event.inputs.tag }}"
          
          # Create manifest for the specified tag that points to platform-specific tags
          docker manifest create ${IMAGE_BASE}:${TAG} \
            --amend ${IMAGE_BASE}:${TAG}-linux-amd64 \
            --amend ${IMAGE_BASE}:${TAG}-linux-arm64
          
          # Push the manifest
          docker manifest push ${IMAGE_BASE}:${TAG}
          
          # If tag is not 'latest', also update latest
          if [ "${TAG}" != "latest" ]; then
            docker manifest create ${IMAGE_BASE}:latest \
              --amend ${IMAGE_BASE}:${TAG}-linux-amd64 \
              --amend ${IMAGE_BASE}:${TAG}-linux-arm64
            docker manifest push ${IMAGE_BASE}:latest
          fi
